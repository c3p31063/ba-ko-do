<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>バーコード読み取り</title>
</head>
<body>
  <h1>バーコード読み取り</h1>
  <button id="start-button">カメラを起動</button>
  <video id="video" width="300" height="200" autoplay></video>
  <p>読み取ったバーコード: <span id="barcode-result">なし</span></p>
  <div id="message"></div>

  <script>
    const video = document.getElementById('video');
    const resultDisplay = document.getElementById('barcode-result');
    const messageDisplay = document.getElementById('message');

    document.getElementById('start-button').addEventListener('click', async () => {
      // カメラへのアクセスをリクエスト
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();
        messageDisplay.textContent = "カメラが起動しました。バーコードをスキャンします...";
        detectBarcode();
      } catch (err) {
        console.error('カメラアクセスエラー:', err);
        messageDisplay.textContent = "カメラへのアクセスができません: " + err.message;
      }
    });

    async function detectBarcode() {
      if ('BarcodeDetector' in window) {
        const barcodeDetector = new BarcodeDetector({ formats: ['qr_code', 'ean_13', 'code_128'] });
        
        // 定期的にバーコードをスキャン
        setInterval(async () => {
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length > 0) {
              const code = barcodes[0].rawValue;
              resultDisplay.textContent = code;

              // バックエンドにバーコードデータを送信
              fetch('/api/save-barcode', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ barcode: code })
              })
              .then(response => response.json())
              .then(data => {
                console.log('サーバーに送信成功:', data);
              })
              .catch(error => {
                console.error('サーバーへの送信エラー:', error);
              });
            }
          } catch (err) {
            console.error('バーコード検出エラー:', err);
          }
        }, 1000);
      } else {
        messageDisplay.textContent = "このブラウザはBarcode Detection APIに対応していません。";
      }
    }
  </script>
</body>
</html>
